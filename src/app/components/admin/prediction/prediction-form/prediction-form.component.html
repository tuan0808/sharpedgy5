<div class="bet-form-modal">
    <!-- Header -->
    <div class="modal-header">
        <h2>Place Your Bet</h2>
        <button type="button" class="close-btn" (click)="activeModal.dismiss()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <div class="modal-body">
        <div class="layout-container">
            <!-- Left Side - Bet Types -->
            <div class="bet-types-section">
                <h3 class="section-title">Bet Type</h3>
                <div class="bet-type-grid">
                    @for (bet of betTypes; track $index) {
                        <button
                                [disabled]="!bet.isEnabled"
                                type="button"
                                (click)="onBetTypeClick(bet)"
                                [class.selected]="selectedBetType === bet.id"
                                [class.disabled]="!bet.isEnabled"
                                class="bet-type-card">
                            <div class="bet-icon">{{ bet.icon }}</div>
                            <div class="bet-label">{{ bet.label }}</div>
                        </button>
                    }
                </div>
            </div>

            <!-- Right Side - Form -->
            <div class="bet-form-section">
                <form [formGroup]="bettingForm" (ngSubmit)="onSubmit()" class="bet-form">

                    @for (field of currentFormFields; track $index) {

                        <!-- DEBUG: Show field info -->
                                <!-- <div style="background: yellow; padding: 5px; margin: 5px;">
                                    Field: {{ field.name }} | Type: {{ field.type }}
                                </div> -->

                                <!-- Team Selector Field -->
                        @if (field.type === 'team-selector') {
                            <div class="form-group">
                                <label class="form-label">{{ field.label }}</label>

                                <div class="team-selection-grid">
                                    @if (selectedBetType === 0) {
                                        <!-- MONEYLINE -->
                                        <button
                                                type="button"
                                                (click)="setSelectedTeam({ name: game.homeTeam.name, abbreviation: game.homeTeam.abbreviation, odds: game.moneylineHome, type: 'home' })"
                                                [class.selected]="selectedTeam?.type === 'home'"
                                                class="team-selection-card">
                                            <div class="team-card-header">
                                                <div class="team-name">{{ game.homeTeam.name }}</div>
                                                <div class="team-abbr">{{ game.homeTeam.abbreviation }}</div>
                                            </div>
                                            <div class="team-card-odds">
                                                <span class="odds-label">Odds</span>
                                                <span class="odds-value">{{ game.moneylineHome >= 0 ? '+' : '' }}{{ game.moneylineHome }}</span>
                                            </div>
                                        </button>

                                        <button
                                                type="button"
                                                (click)="setSelectedTeam({ name: game.awayTeam.name, abbreviation: game.awayTeam.abbreviation, odds: game.moneylineAway, type: 'away' })"
                                                [class.selected]="selectedTeam?.type === 'away'"
                                                class="team-selection-card">
                                            <div class="team-card-header">
                                                <div class="team-name">{{ game.awayTeam.name }}</div>
                                                <div class="team-abbr">{{ game.awayTeam.abbreviation }}</div>
                                            </div>
                                            <div class="team-card-odds">
                                                <span class="odds-label">Odds</span>
                                                <span class="odds-value">{{ game.moneylineAway >= 0 ? '+' : '' }}{{ game.moneylineAway }}</span>
                                            </div>
                                        </button>
                                    }

                                    @else if (selectedBetType === 1) {
                                        <!-- POINT SPREAD -->
                                        <button
                                                type="button"
                                                (click)="setSelectedTeam({ name: game.homeTeam.name, abbreviation: game.homeTeam.abbreviation, odds: -110, spread: game.spread, type: 'home' })"
                                                [class.selected]="selectedTeam?.type === 'home'"
                                                class="team-selection-card">
                                            <div class="team-card-header">
                                                <div class="team-name">{{ game.homeTeam.name }}</div>
                                                <div class="team-abbr">{{ game.homeTeam.abbreviation }}</div>
                                            </div>
                                            <div class="team-card-spread">
                                                <span class="spread-value">{{ game.spread >= 0 ? '+' : '' }}{{ game.spread }}</span>
                                                <span class="spread-odds">(-110)</span>
                                            </div>
                                        </button>

                                        <button
                                                type="button"
                                                (click)="setSelectedTeam({ name: game.awayTeam.name, abbreviation: game.awayTeam.abbreviation, odds: -110, spread: -game.spread, type: 'away' })"
                                                [class.selected]="selectedTeam?.type === 'away'"
                                                class="team-selection-card">
                                            <div class="team-card-header">
                                                <div class="team-name">{{ game.awayTeam.name }}</div>
                                                <div class="team-abbr">{{ game.awayTeam.abbreviation }}</div>
                                            </div>
                                            <div class="team-card-spread">
                                                <span class="spread-value">{{ -game.spread >= 0 ? '+' : '' }}{{ -game.spread }}</span>
                                                <span class="spread-odds">(-110)</span>
                                            </div>
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        @else if (field.type === 'richtext') {
                            <div class="form-group">
                                <label [for]="field.name" class="form-label">{{ field.label }}</label>
                                <div class="editor-wrapper">
                                    @if (getEditor(field.name)) {
                                        <div class="ngx-editor-menu">
                                            <ngx-editor-menu [editor]="getEditor(field.name)!" [toolbar]="toolbar"></ngx-editor-menu>
                                        </div>
                                        <ngx-editor
                                                [editor]="getEditor(field.name)!"
                                                [formControlName]="field.name"
                                                [placeholder]="field.placeholder || 'Enter text...'"
                                                class="ngx-editor-content">
                                        </ngx-editor>
                                    }
                                </div>
                                @if (bettingForm.get(field.name)?.errors?.['required']) {
                                    <div class="error-text">This field is required</div>
                                }
                            </div>
                        }

                        @else if (field.type === 'number' || field.name === 'amount') {
                            <div class="form-group">
                                <label [for]="field.name" class="form-label">{{ field.label }}</label>
                                <div class="input-wrapper amount-input">
                                    <span class="input-prefix">$</span>
                                    <input
                                            [id]="field.name"
                                            type="text"
                                            [formControlName]="field.name"
                                            [placeholder]="field.placeholder || '0.00'"
                                            (input)="onAmountInput($event, field.name)"
                                            (blur)="formatAmountOnBlur(field.name)"
                                            class="form-input">
                                </div>
                                @if (bettingForm.get(field.name)?.errors?.['max']) {
                                    <div class="error-text">Maximum bet amount is ${{ field.max }}</div>
                                }
                                @if (bettingForm.get(field.name)?.errors?.['min']) {
                                    <div class="error-text">Minimum bet amount is ${{ field.min }}</div>
                                }
                                @if (bettingForm.get(field.name)?.errors?.['invalidNumber']) {
                                    <div class="error-text">Please enter a valid number</div>
                                }
                            </div>
                        }

                        @else if (field.type === 'slider') {
                            <div class="form-group">
                                <label [for]="field.name" class="form-label">{{ field.label }}</label>
                                <div class="slider-wrapper">
                                    <input
                                            [id]="field.name"
                                            type="range"
                                            [formControlName]="field.name"
                                            [min]="field.min"
                                            [max]="field.max"
                                            [step]="field.step || 1"
                                            (input)="updatePotentialWinnings()"
                                            class="form-slider">
                                    <div class="slider-value-display">
                                        <span class="value">{{ bettingForm.get(field.name)?.value || 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        }

                        @else if (field.type === 'radio' && selectedBetType === 2) {
                            <!-- OVER/UNDER -->
                            <div class="form-group">
                                <label class="form-label">{{ field.label }}</label>
                                <div class="team-selection-grid">
                                    <button
                                            type="button"
                                            (click)="setOverUnderSelection('OVER', field.name)"
                                            [class.selected]="bettingForm.get(field.name)?.value === 'OVER'"
                                            class="team-selection-card">
                                        <div class="team-card-header">
                                            <div class="team-name">Over</div>
                                            <div class="team-abbr">{{ game.overUnder }}</div>
                                        </div>
                                        <div class="team-card-odds">
                                            <span class="odds-label">Odds</span>
                                            <span class="odds-value">-110</span>
                                        </div>
                                    </button>

                                    <button
                                            type="button"
                                            (click)="setOverUnderSelection('UNDER', field.name)"
                                            [class.selected]="bettingForm.get(field.name)?.value === 'UNDER'"
                                            class="team-selection-card">
                                        <div class="team-card-header">
                                            <div class="team-name">Under</div>
                                            <div class="team-abbr">{{ game.overUnder }}</div>
                                        </div>
                                        <div class="team-card-odds">
                                            <span class="odds-label">Odds</span>
                                            <span class="odds-value">-110</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        }

                        @else if (field.type === 'select') {
                            <div class="form-group">
                                <label [for]="field.name" class="form-label">{{ field.label }}</label>
                                <select
                                        [id]="field.name"
                                        [formControlName]="field.name"
                                        class="form-select">
                                    @for (option of field.options; track $index) {
                                        <option [value]="option.value">{{ option.label }}</option>
                                    }
                                </select>
                            </div>
                        }
                    }

                    @if (potentialWinnings > 0) {
                        <div class="winnings-card">
                            <div class="winnings-content">
                                <div class="winnings-label">
                                    <i class="bi bi-trophy"></i>
                                    <span>Potential Winnings</span>
                                </div>
                                <div class="winnings-amount">${{ potentialWinnings.toFixed(2) }}</div>
                            </div>
                        </div>
                    }

                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" (click)="activeModal.dismiss()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-submit" [disabled]="!isFormValid()">
                            <i class="bi bi-check-circle"></i>
                            <span>Place Bet</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
